## Installing and running Hakuvahti

- `npm i` to install dependencies
- Copy .env.dist as .env and configure MongoDB + ElasticProxy settings.
- Create MongoDB collections: `npm run hav:initialize-mongo-collections`
- `npm start` (or `npm run dev` for development)

## REST Endpoints:

`/subscription (POST)`

Adds news Hakuvahti subscription:

```
{
    "elastic_query": "test", // Query for elatic proxy
    "query": "test",         // Queryparam URL at the website for linkback
    "email": "test asd",     // Subscriber email. This will be hashed automatically
    "lang": "fi"             // Locale for email templates.
}
```

`/subscription/confirm/:id/:hash (GET)`

Confirms a subscription. To confirm a subscription, user must know both the id and hash (hash field in collection).

`/subscription/delete/:id/:hash (DELETE)`

Deletes a subscription. To delete a subscription, user must know both the id and hash (hash field in collection).

### Command line actions

`npm run hav:initialize-mongo-collections`

ONLY for initializing the setup. Creates MongoDB Collection schemas.

`npm run hav:populate-email-queue`

Queries all Hakuvahti entries and checks for new results in ElasticSearch. This populates the email queue.

`npm run hav:send-emails-from-queue`

Sends emails in queue that were generated by `hav:populate-email-queue`

`npm run hav:list-emails-in-queue`

Lists emails in queue that were generated by `hav:populate-email-queue` (for debugging)

`npm run hav:purge-emails-in-queue`

PURGE all emails in queue! (for debugging)

### TODO:

- Finish token auth in src/plugins/token.ts
- Finish ATV integration in src/plugins/atv.ts
