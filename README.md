## Installing and running Hakuvahti

- `npm i` to install dependencies
- Copy `.env.dist` as `.env` and configure:
  - MongoDB,
  - ElasticProxy, 
  - SMTP settings for email sending,
  - [ATV integration](https://github.com/City-of-Helsinki/atv)
  - Subscription days, etc settings
- Create MongoDB collections: `npm run hav:init-mongodb`
- `npm start` (or `npm run dev` for development)
- Hakuvahti should now be running in port `:3000` (by default)
- For production environment, add following commands to cron:
  - `npm run hav:populate-email-queue`
  - `npm run hav:send-emails-from-queue`

# REST Endpoints:

## Add Subscription

`POST` `/subscription`

Adds new Hakuvahti subscription:

```
{
    "elastic_query": "<full elastic query as base64 encoded string>",
    "search_description": "<Some search with terms, used in email notifications>",
    "query": "<url back to webpage for search results>",
    "email": "<email to subscribe>",
    "lang": "fi"
}
```

## Confirm a subscription

`GET` `/subscription/confirm/:id/:hash`

Confirms a subscription. To confirm a subscription, user must know both the id and hash (`hash` field in collection).

Subscriptions that are not confirmed, will not be checked during `npm run hav:populate-email-queue ` command.

## Delete a subscription

`DELETE` `/subscription/delete/:id/:hash`

Deletes a subscription. To delete a subscription, user must know both the id and hash (`hash` field in collection).

## Command line / cron actions

### Initialize MongoDB collections

`npm run hav:init-mongodb`

Initialize MongoDB collections. Required before running populate or send commands.

### Query for new results for subscriptions

`npm run hav:populate-email-queue`

Queries all Hakuvahti entries and checks for new results in ElasticSearch. This populates the email queue.

Removes expired subscriptions.

Adds following emails to the email queue:

- New results from ElasticQuery queries
- Notifications if subscription is going to expire

### Sends emails from queue

`npm run hav:send-emails-from-queue`

Sends emails in queue that were generated by `hav:populate-email-queue`
